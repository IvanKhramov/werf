---
title: Чарты
permalink: usage/deploy/charts.html
---

## О чартах

Чарты в werf это Helm-чарты с некоторыми дополнительными возможностями. А Helm-чарты это распространяемые пакеты с Helm-шаблонами, values-файлами и некоторыми метаданными. Из чартов формируются конечные Kubernetes-манифесты для дальнейшего развертывания.

## Чарт по умолчанию

При запуске команд вроде `werf converge` или `werf render` werf по умолчанию использует чарт, лежащий в директории `<корень Git-репозитория>/.helm`. Этот чарт называется *основным* чартом. Директорию с основным чартом можно изменить директивой `deploy.helmChartDir` файла `werf.yaml`.

В основном чарте, в отличие от обычного чарта, может не быть файла `Chart.yaml`. В таком случае будет использоваться следующий `.helm/Chart.yaml` :

```yaml
# .helm/Chart.yaml:
apiVersion: v2
name: <имя проекта werf>
version: 1.0.0
```

Если в `.helm/Chart.yaml` нужно изменить значение вышеупомянутых директив, либо добавить новые, то создайте файл `.helm/Chart.yaml` самостоятельно, добавив/переопределив интересующие директивы.

Если вы хотите использовать чарт из OCI/HTTP-репозитория вместо локального чарта или разворачивать несколько чартов сразу, то просто укажите интересующие вас чарты как зависимые для основного чарта. Используйте для этого директиву `dependencies` файла `Chart.yaml`.

## Создание нового чарта

Создайте новую директорию `mychart` в произвольном месте. В директории создайте файл `Chart.yaml` с именем чарта и его версией, например:

```yaml
# mychart/Chart.yaml:
apiVersion: v2
name: mychart
version: 1.0.0
```

Если ваш чарт будет содержать только именованные шаблоны для использования в других чартах, то добавьте директиву `type: library`:

```yaml
# mychart/Chart.yaml:
type: library
```

Если ваш чарт совместим только с частью версий Kubernetes, то ограничьте версии кластера Kubernetes, в которые чарт можно развернуть, директивой `kubeVersion`, например:

```yaml
# mychart/Chart.yaml:
kubeVersion: "~1.20.3"
```

При желании можно добавить следующие информационные директивы:

```yaml
# mychart/Chart.yaml:
appVersion: "1.0"
deprecated: false
icon: https://example.org/mychart-icon.svg
description: This is My Chart
home: https://example.org
sources:
  - https://github.com/my/chart
keywords:
  - apps
annotations:
  anyAdditionalInfo: here
maintainters:
  - name: John Doe
    email: john@example.org
    url: https://john.example.org
```

Полученный чарт уже можно опубликовать и развернуть, хотя в таком виде от чарта мало пользы. Теперь вам понадобится, по меньшей мере, либо добавить шаблоны в директорию `templates`, либо подключить зависимые чарты.

## Добавление файлов в чарт

Наполните чарт необходимыми шаблонами, параметрами, зависимыми чартами и прочим. Содержимое чарта может выглядеть так:

```
mychart/
  charts/
    dependent-chart/
      # ...
  templates/
    deployment.yaml
    _helpers.tpl
    NOTES.txt
  crds/
    crd.yaml
  secret/                   # Только в werf
    some-secret-file
  values.yaml
  values.schema.json
  secret-values.yaml        # Только в werf
  Chart.yaml
  Chart.lock
  README.md
  LICENSE
  .helmignore
```

Подробнее:

- `charts/*` — зависимые чарты, чьи Helm-шаблоны/values-файлы используются для формирования манифестов наравне с Helm-шаблонами/values-файлами родительского чарта;

- `templates/*.yaml` — Helm-шаблоны, из которых формируются Kubernetes-манифесты;

- `templates/*.tpl` — файлы с Helm-шаблонами для использования в других Helm-шаблонах. Результат шаблонизации этих файлов игнорируется;

- `templates/NOTES.txt` — werf отображает содержимое этого файла в терминале в конце каждого удачного развертывания;

- `crds/*.yaml` — [Custom Resource Definitions](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions), которые развертываются до развертывания манифестов в `templates`;

- `secret/*` — (только в werf) зашифрованные файлы, расшифрованное содержимое которых можно подставлять в Helm-шаблоны;

- `values.yaml` — файлы с декларативной конфигурацией для использования в Helm-шаблонах. Конфигурация в них может переопределяться переменными окружения, аргументами командной строки или другими values-файлами;

- `values.schema.json` — JSON-схема для валидации `values.yaml`;

- `secret-values.yaml` — (только в werf) зашифрованный файл с декларативной конфигурацией, аналогичный `values.yaml`. Его расшифрованное содержимое объединяется с `values.yaml` во время формирования манифестов;

- `Chart.yaml` — основная конфигурация и метаданные чарта;

- `Chart.lock` — lock-файл, защищающий от нежелательного изменения/обновления зависимых чартов;

- `README.md` — документация чарта;

- `LICENSE` — лицензия чарта;

- `.helmignore` — список файлов в директории чарта, которые не нужно включать в чарт при его публикации.

## Подключение зависимых чартов

### Добавление/обновление зависимого чарта

Чарт может зависеть от других чартов. В таком случае манифесты сформируются и для родительского, и для зависимых чартов, после чего объединятся вместе для дальнейшего развертывания. Зависимые чарты настраиваются директивой `dependencies` файла `Chart.yaml`, например:

```yaml
# Chart.yaml:
dependencies:
- name: backend
  version: "~1.2.3"
  repository: https://example.com/charts
```

После каждого добавления/обновления зависимых чартов или их конфигурации требуется:

1. (Если используется приватный OCI или HTTP-репозитория c зависимым чартом) Добавить OCI или HTTP-репозиторий вручную с `werf helm repo add`, указав нужные опции для доступа к репозиторию.

2. Вызвать `werf helm dependency update`, который обновит `Chart.lock`.

3. Закоммитить обновлённые `Chart.yaml` и `Chart.lock` в Git.

Также рекомендуется добавить `.helm/charts/**.tgz` в `.gitignore`.

### Указание имени зависимого чарта

В директиве `dependencies[].name` должно быть указано оригинальное имя зависимого чарта, установленное разработчиком чарта, например:

```yaml
# Chart.yaml:
dependencies:
- name: backend
```

Если нужно подключить несколько чартов с одинаковым именем или подключить один и тот же чарт несколько раз, то используйте директиву `dependencies[].alias`, чтобы поменять имена подключаемых чартов, например:

```yaml
# Chart.yaml:
dependencies:
- name: backend
  alias: main-backend
- name: backend
  alias: secondary-backend
```

### Указание версии зависимого чарта

Ограничить подходящие версии зависимого чарта, из которых будет выбрана наиболее свежая, можно директивой `dependencies[].version`, например:

```yaml
# Chart.yaml:
dependencies:
- name: backend
  version: "~1.2.3"
```

Результат: будет использована самая свежая версия 1.2.x, но как минимум 1.2.3.

### Указание репозитория зависимого чарта

Указать путь к источнику чартов, в котором можно найти указанный зависимый чарт, можно директивой `dependencies[].repository`, например:

```yaml
# Chart.yaml:
dependencies:
- name: mychart
  repository: oci://example.org/myrepo
```

Результат: будет использован чарт `mychart` из OCI-репозитория `example.org/myrepo`.

### Включение/выключение зависимых чартов

По умолчанию все зависимые чарты включены. Для произвольного включения/выключения зависимых чартов можно использовать директиву `dependencies[].condition`, например:

```yaml
# Chart.yaml:
dependencies:
- name: backend
  condition: backend.enabled
```

Результат: чарт `backend` будет включен, если параметр `$.Values.backend.enabled` имеет значение `true` (по умолчанию — `true`).

Также можно использовать директиву `dependencies[].tags` для включения/выключения целых групп зависимых чартов сразу, например:

```yaml
# Chart.yaml:
dependencies:
- name: backend
  tags: ["app"]
- name: frontend
  tags: ["app"]
```

Результат: чарты `backend` и `frontend` будут включены, если параметр `$.Values.tags.app` имеет значение `true` (по умолчанию — `true`).
