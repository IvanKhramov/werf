---
title: Очистка container registry
permalink: usage/cleanup/cleanup.html
---

Команда [**werf cleanup**]({{ "reference/cli/werf_cleanup.html" | true_relative_url }}) рассчитана на периодический запуск по расписанию. Удаление производится в соответствии с принятыми политиками очистки и является безопасной процедурой.

Алгоритм автоматически за пользователя выбирает образы, которые следует удалить. Алгоритм очистки может быть представлен следующими шагами:

- Получение необходимых данных из container registry.
- Подготовка списка образов, которые не должны быть удалены:
  - [Образы, которые используются в Kubernetes](#образы-в-kubernetes).
  - Образы, которые попадают под [пользовательские политики](#пользовательские-политики) при [сканировании истории git](#сканирование-истории-git).
  - Свежие образы, которые собирались за определённый период времени (регулируется опцией `--keep-stages-built-within-last-n-hours`, по умолчанию за последние два часа).
  - Связанные образы для получившегося на предыдущих шагах списка.
- Удаление оставшихся образов.

#### Образы в Kubernetes

werf подключается **ко всем кластерам** Kubernetes, описанным **во всех контекстах** конфигурации kubectl, и собирает имена образов для следующих типов объектов: `pod`, `deployment`, `replicaset`, `statefulset`, `daemonset`, `job`, `cronjob`, `replicationcontroller`.

Пользователь может регулировать поведение следующими параметрами (и связанными переменными окружения):
- `--kube-config`, `--kube-config-base64` для определения конфигурации kubectl (по умолчанию используется пользовательская конфигурация `~/.kube/config`).
- `--kube-context` для выполнения сканирования только в определённом контексте.
- `--scan-context-namespace-only` для сканирования только связанного с контекстом namespace (по умолчанию все).
- `--without-kube` для отключения сканирования Kubernetes.

Пока в кластере Kubernetes существует объект использующий образ, он никогда не удалится из container registry. Другими словами, если что-то было запущено в вашем кластере Kubernetes, то используемые образы ни при каких условиях не будут удалены при очистке.

#### Сканирование истории git

В основу алгоритма очистки ложится тот факт, что в container registry сохраняется информация о коммитах, на которых выполняется сборка (добавился, изменился или нет образ в container registry — не имеет значения). При каждой сборке сохраняется связка коммит, [дайджест стадии]({{ "usage/build/stages_and_storage.html#дайджест-стадии" | true_relative_url }}) и имя образа — для каждого `image` из `werf.yaml`.

При сборке очередного коммита _конечный образ_ может не измениться, тем не менее в container registry добавится запись с информацией о том, что сборка [дайджеста стадии]({{ "usage/build/stages_and_storage.html#дайджест-стадии" | true_relative_url }}) соответствует определённому коммиту.

Таким образом, обеспечивается связь [дайджеста стадии]({{ "usage/build/stages_and_storage.html#дайджест-стадии" | true_relative_url }}) с историей git и появляется возможность организации эффективной очистки неактуальных образов на основе состояния git и [выбранных политик](#пользовательские-политики). Алгоритм сканирует историю git и отбирает значимые образы.

Информация о коммитах является единственным источником правды при работе алгоритма, поэтому образы без подобной информации будут удалены.

#### Пользовательские политики

Используя [политики очистки]({{ "usage/cleanup/cleanup.html" | true_relative_url }}), `keepPolicies`, пользователь определяет образы, которые не должны удаляться при очистке. При отсутствии конфигурации в `werf.yaml` будет использован [набор политик по умолчанию]({{ "reference/werf_yaml.html#политики-по-умолчанию" | true_relative_url }}).

Стоит отметить, что алгоритм сканирует локальное состояние git репозитория и актуальность git-веток и git-тегов крайне важна. По умолчанию werf выполняет синхронизацию автоматически (поведение регулируется в `werf.yaml` директивой [gitWorktree.allowFetchOriginBranchesAndTags]({{ "reference/werf_yaml.html#git-worktree" | true_relative_url }})).

#### Особенность очистки собираемых образов

При очистке пользовательские политики применяются к набору образов для каждого `image` из `werf.yaml`. Очистка должна учитывать все используемые `image` и для этого не всегда достаточно набора из основной ветки git-репозитория (к примеру, при разработке в feature-ветке могут добавляться/удаляться `image`).

Для того, чтобы избежать удаления рабочих образов и стадий, при сборке в container registry добавляется имя собираемого образа. Такой подход позволяет отвязаться от набора имён в `werf.yaml` при выполнении периодической очистки и учитывать все когда-либо используемые образы.

Набор команд `werf managed-images ls|add|rm` позволяет пользователю редактировать так называемый набор _managed images_ и явно удалять образы, которые более не должны участвовать в очистке и могут быть полностью удалены.
